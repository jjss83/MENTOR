<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mentor Train Monitor</title>
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <style>
    :root {
      --bg: #0b0c0f;
      --glass: rgba(255, 255, 255, 0.06);
      --stroke: rgba(255, 255, 255, 0.12);
      --text: #e7e9ee;
      --muted: #9ba1b0;
      --accent: #7dd3fc;
      --success: #6ee7b7;
      --error: #f47272;
      --warning: #f6c263;
      --card-radius: 18px;
      --shadow: 0 20px 60px rgba(0, 0, 0, 0.45);
      --embed-height: 360px;
      --log-height: 140px;
    }
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      min-height: 100vh;
      font-family: "SF Pro Display", "Segoe UI Variable", "Helvetica Neue", sans-serif;
      color: var(--text);
      background: radial-gradient(circle at 20% 20%, #1d2433, transparent 35%),
                  radial-gradient(circle at 80% 0%, #132032, transparent 30%),
                  linear-gradient(145deg, #06070a, #0d1118 60%, #0f1724);
      letter-spacing: 0.01em;
    }
    .page {
      max-width: 2000px;
      margin: 0 auto;
      padding: 32px 26px 48px;
    }
    header {
      display: flex;
      flex-direction: column;
      gap: 18px;
    }
    .top-line {
      display: flex;
      justify-content: space-between;
      gap: 18px;
      flex-wrap: wrap;
      align-items: flex-end;
    }
    .eyebrow {
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--muted);
      font-size: 11px;
    }
    h1 {
      margin: 6px 0 6px;
      font-size: 34px;
      font-weight: 700;
      color: #f4f6fb;
    }
    .subtitle {
      margin: 0;
      color: var(--muted);
      max-width: 560px;
      line-height: 1.4;
    }
    .controls {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    .embed-card {
      background: var(--glass);
      border: 1px solid var(--stroke);
      border-radius: var(--card-radius);
      padding: 14px 16px 10px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
    }
    .embed-frame {
      width: 100%;
      height: var(--embed-height);
      border: 1px solid var(--stroke);
      border-radius: 12px;
      overflow: hidden;
      margin: 0 auto;
    }
    .embed-frame iframe {
      width: 100%;
      height: 100%;
      border: 0;
      background: #0b0c0f;
    }
    .slider-wrap {
      background: var(--glass);
      border: 1px solid var(--stroke);
      padding: 10px 12px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 240px;
      box-shadow: var(--shadow);
    }
    .tb-controls {
       display: flex;
       flex-wrap: wrap;
       gap: 10px;
       align-items: center;
       margin: 10px 0 4px;
     }
    .slider-label {
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-width: 120px;
    }
    .slider-value {
      font-weight: 600;
      color: var(--text);
    }
    input[type="range"] {
      accent-color: #7dd3fc;
      width: 140px;
    }
    .input-wrap {
      background: var(--glass);
      border: 1px solid var(--stroke);
      padding: 10px 12px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 260px;
      box-shadow: var(--shadow);
    }
    label {
      font-size: 12px;
      color: var(--muted);
    }
    input {
      background: transparent;
      border: none;
      outline: none;
      color: var(--text);
      font-size: 14px;
      width: 100%;
    }
    button {
      background: linear-gradient(120deg, #8ec5ff, #7dd3fc);
      color: #0a0c10;
      border: none;
      border-radius: 12px;
      padding: 10px 16px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 12px 30px rgba(125, 211, 252, 0.25);
      transition: transform 120ms ease, box-shadow 120ms ease, opacity 120ms ease;
    }
    button.secondary {
      background: rgba(255, 255, 255, 0.08);
      color: var(--text);
      border: 1px solid var(--stroke);
      box-shadow: none;
    }
    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 16px 36px rgba(125, 211, 252, 0.3);
    }
    button:active {
      transform: translateY(0);
      opacity: 0.92;
    }
    .icon-btn {
      padding: 8px;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid var(--stroke);
      border-radius: 12px;
      box-shadow: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: var(--text);
      min-width: 0;
      line-height: 0;
      transition: transform 120ms ease, border-color 120ms ease, background 120ms ease, opacity 120ms ease;
    }
    .icon-btn:hover { background: rgba(255, 255, 255, 0.12); border-color: var(--accent); transform: translateY(-1px); }
    .icon-btn:active { transform: translateY(0); opacity: 0.9; }
    .icon-btn svg { width: 16px; height: 16px; }
    .icon-btn.spinning svg { animation: spin 0.8s linear infinite; }
    .icon-btn.error { border-color: var(--error); color: var(--error); }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .status-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
    }
    .tile {
      background: var(--glass);
      border: 1px solid var(--stroke);
      border-radius: var(--card-radius);
      padding: 14px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
    }
    .health-dot {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      box-shadow: 0 0 0 6px rgba(110, 231, 183, 0.1);
      background: var(--success);
    }
    .health-dot.off {
      background: var(--error);
      box-shadow: 0 0 0 6px rgba(244, 114, 114, 0.1);
    }
    .health-dot.degraded {
      background: var(--warning);
      box-shadow: 0 0 0 6px rgba(246, 194, 99, 0.12);
    }
    .tile-title {
      font-size: 13px;
      color: var(--muted);
    }
    .tile-value {
      font-size: 18px;
      font-weight: 700;
    }
    .pill-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 10px;
      margin: 8px 0 4px;
    }
    .pill {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--stroke);
      border-radius: 14px;
      padding: 12px 14px;
      box-shadow: var(--shadow);
    }
    .pill-label { color: var(--muted); font-size: 12px; }
    .pill-value { font-size: 20px; font-weight: 700; }
    .process-card { gap: 10px; }
    .process-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 12px;
      align-items: flex-start;
    }
    .micro-label { color: var(--muted); font-size: 12px; margin-top: 6px; }
    .chip-row { display: flex; flex-wrap: wrap; gap: 8px; }
    .chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 7px 12px;
      background: rgba(255, 255, 255, 0.06);
      border: 1px solid var(--stroke);
      border-radius: 999px;
      font-size: 12px;
    }
    .chip.alert { border-color: var(--warning); color: var(--warning); }
    .action-row {
      display: grid;
      grid-template-columns: 1fr;
      gap: 6px;
      margin-top: 4px;
    }
    .action-controls {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }
    select {
      background: rgba(255, 255, 255, 0.06);
      border: 1px solid var(--stroke);
      border-radius: 10px;
      color: var(--text);
      padding: 10px 12px;
      min-width: 220px;
    }
    main {
      margin-top: 18px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .section-head {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 12px;
      flex-wrap: wrap;
    }
    .section-title { font-size: 18px; font-weight: 700; }
    .section-note { color: var(--muted); font-size: 13px; }
    .selection-note { color: var(--muted); font-size: 13px; display: flex; align-items: center; gap: 8px; }
    .selection-chip {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(255, 255, 255, 0.06);
      color: var(--text);
      font-size: 12px;
    }
    .clear-btn {
      background: rgba(255, 255, 255, 0.06);
      border: 1px solid var(--stroke);
      color: var(--text);
      padding: 6px 10px;
      border-radius: 8px;
      cursor: pointer;
    }
    .clear-btn:hover { opacity: 0.9; }
    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 14px;
    }
    .card {
      background: var(--glass);
      border: 1px solid var(--stroke);
      border-radius: var(--card-radius);
      padding: 16px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .card.selected { border-color: var(--accent); box-shadow: 0 0 0 1px rgba(125, 211, 252, 0.4); }
    .card.collapsed { opacity: 0.82; }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }
    .card-actions { display: inline-flex; align-items: center; gap: 8px; }
    .run-id {
      font-weight: 700;
      font-size: 16px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .status-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid var(--stroke);
      font-size: 12px;
      text-transform: capitalize;
    }
    .status-dot {
      width: 9px;
      height: 9px;
      border-radius: 50%;
    }
    .status-running .status-dot { background: var(--accent); }
    .status-succeeded .status-dot { background: var(--success); }
    .status-failed .status-dot { background: var(--error); }
    .status-canceled .status-dot { background: var(--warning); }
    .status-unknown .status-dot { background: #94a3b8; }
    .status-not-found .status-dot { background: #94a3b8; }
    .meta-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 8px; }
    .meta {
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid var(--stroke);
      font-size: 13px;
    }
    .label { color: var(--muted); font-size: 12px; margin-bottom: 2px; }
    .log {
      background: rgba(0, 0, 0, 0.35);
      border: 1px solid var(--stroke);
      border-radius: 12px;
      padding: 10px 12px;
      font-family: "SF Mono", "JetBrains Mono", "Menlo", monospace;
      color: #dfe5f5;
      font-size: 12px;
      white-space: pre-wrap;
      max-height: var(--log-height);
      overflow: hidden;
    }
    .log-actions {
      display: flex;
      justify-content: flex-end;
      margin-top: 6px;
    }
    .detail-text {
      width: 100%;
      background: rgba(0, 0, 0, 0.35);
      border: 1px solid var(--stroke);
      border-radius: 12px;
      color: #dfe5f5;
      font-family: "SF Mono", "JetBrains Mono", "Menlo", monospace;
      font-size: 12px;
      line-height: 1.55;
      padding: 10px 12px;
      box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.25);
      column-width: 420px;
      column-gap: 16px;
      word-break: break-word;
      white-space: normal;
    }
    .detail-list {
      display: block;
    }
    .detail-line {
      display: block;
      break-inside: avoid;
      border-left: 2px solid var(--stroke);
      padding-left: 10px;
      margin-bottom: 6px;
    }
    .detail-key {
      color: var(--muted);
      min-width: 140px;
      display: inline-block;
      margin-right: 6px;
    }
    .detail-value {
      color: #e7e9ee;
      word-break: break-word;
    }
    .detail-value.positive { color: var(--success); }
    .detail-value.warning { color: var(--warning); }
    .detail-value.negative { color: var(--error); }
    .resume-row {
      display: flex;
      align-items: center;
      gap: 10px;
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid var(--stroke);
      border-radius: 12px;
      padding: 10px 12px;
    }
    .resume-note { color: var(--muted); font-size: 12px; }
    .resume-inline {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 8px;
      border: 1px solid var(--stroke);
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.04);
    }
    .log-actions button {
      padding: 8px 12px;
      border-radius: 10px;
    }
    .empty {
      text-align: center;
      padding: 18px;
      color: var(--muted);
      border: 1px dashed var(--stroke);
      border-radius: var(--card-radius);
      background: rgba(255, 255, 255, 0.02);
    }
    @media (max-width: 640px) {
      .page { padding: 22px 18px 32px; }
      h1 { font-size: 28px; }
      .card { padding: 14px; }
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <div class="top-line">
        <div>
          <div class="eyebrow">Mentor</div>
          <h1>Train Monitor</h1>
          <p class="subtitle">MENTOR keeps tabs on your training runs, surfacing health, counts, and live log tails in one glance.</p>
        </div>
        <div class="controls">
          <div class="input-wrap">
            <label for="api-base">API</label>
            <input id="api-base" type="text" spellcheck="false" aria-label="API base" />
          </div>
          <div class="slider-wrap" aria-label="Refresh cadence">
            <div class="slider-label">
              <div class="label">Refresh cadence</div>
              <div class="slider-value"><span id="refresh-seconds">5</span>s</div>
            </div>
            <input id="refresh-slider" type="range" min="1" max="10" step="1" value="5" aria-label="Refresh cadence (seconds)" />
          </div>
        <button id="refresh" class="secondary">Refresh now</button>
      </div>
      </div>
      <div class="status-row">
        <div class="tile">
          <div id="health-dot" class="health-dot"></div>
          <div>
            <div class="tile-title">API health</div>
            <div id="health-label" class="tile-value">Checking...</div>
          </div>
        </div>
        <div class="tile">
          <div>
            <div class="tile-title">Auto refresh</div>
            <div class="tile-value" id="refresh-label">Every 5s</div>
          </div>
        </div>
        <div class="tile">
          <div>
            <div class="tile-title">Last updated</div>
            <div class="tile-value" id="updated-label">-</div>
          </div>
        </div>
      </div>
    </header>

    <main>
      <section id="tensorboard-embed" class="embed-card" hidden>
        <div class="section-head">
          <div>
            <div class="section-title">TensorBoard - Environment / Cumulative Reward</div>
            <div class="section-note" id="tensorboard-note"></div>
          </div>
          <div class="pill-row">
            <button id="toggle-tensorboard" class="secondary">Collapse</button>
            <button id="start-tensorboard" class="secondary">Start TensorBoard</button>
          </div>
        </div>
        <div class="tb-controls">
          <div class="slider-wrap" aria-label="TensorBoard height">
            <div class="slider-label">
              <div class="label">TensorBoard height</div>
              <div class="slider-value"><span id="embed-height-value">360</span>px</div>
            </div>
            <input id="embed-height-slider" type="range" min="240" max="1200" step="20" value="360" aria-label="TensorBoard height (px)" />
          </div>
        </div>
        <div class="embed-frame">
          <iframe id="tensorboard-frame" title="TensorBoard Environment Cumulative Reward"></iframe>
        </div>
      </section>

      <section>
        <div class="pill-row">
          <div class="pill">
            <div class="pill-label">Running</div>
            <div class="pill-value" id="running-count">0</div>
          </div>
          <div class="pill">
            <div class="pill-label">Completed</div>
            <div class="pill-value" id="completed-count">0</div>
          </div>
          <div class="pill">
            <div class="pill-label">Failures</div>
            <div class="pill-value" id="failed-count">0</div>
          </div>
        </div>
      </section>

      <section class="card process-card">
        <div class="section-head">
          <div class="section-title">Process watch</div>
          <div class="section-note" id="process-note">Waiting for first update...</div>
        </div>
        <div class="process-row">
          <div>
            <div class="pill-label">mlagents-learn.exe</div>
            <div class="pill-value" id="mlagents-count">0</div>
            <div class="micro-label" id="mlagents-note">processes running</div>
          </div>
          <div>
            <div class="pill-label">Environment executables</div>
            <div id="env-running" class="chip-row"></div>
            <div class="micro-label" id="env-note">Discovering env executables from results folders.</div>
          </div>
        </div>
        <div class="action-row">
          <div class="pill-label">Kill processes</div>
          <div class="action-controls">
            <select id="kill-select" aria-label="Executable to kill">
              <option value="">Select executable</option>
            </select>
            <button id="kill-btn" class="secondary">Kill all</button>
          </div>
          <div class="micro-label" id="kill-note">Choose an executable to terminate its running processes.</div>
        </div>
      </section>

      <section>
        <div class="slider-wrap" aria-label="Run log height">
          <div class="slider-label">
            <div class="label">Run log height</div>
            <div class="slider-value"><span id="log-height-value">140</span>px</div>
          </div>
          <input id="log-height-slider" type="range" min="100" max="400" step="20" value="140" aria-label="Run log height (px)" />
        </div>
      </section>

      <section>
        <div class="section-head">
          <div class="section-title">Runs</div>
          <div class="section-note" id="runs-note"></div>
          <div class="selection-note">
            <span class="selection-chip" id="selection-chip">0 of 0 showing details</span>
            <button class="clear-btn" id="clear-selection">Show all details</button>
          </div>
        </div>
        <div id="run-grid" class="grid"></div>
      </section>
    </main>
  </div>

  <script>
    (() => {
      const state = {
        apiBase: localStorage.getItem('mentorApiBase') || 'http://localhost:5113',
        refreshMs: 5000,
        refreshHandle: null,
        tickerHandle: null,
        nextRefreshAt: null,
        embedHeight: 360,
        logHeight: 140,
        knownEnvExecutables: [],
        hiddenRuns: new Set(),
        lastRuns: [],
        tensorboardUrl: null,
        forceTensorboardReload: false,
        tensorboardCollapsed: false,
      };

      const defaultTensorboardUrl = 'http://localhost:6006/';

      const storedRefreshMs = Number(localStorage.getItem('mentorRefreshMs'));
      if (storedRefreshMs >= 1000 && storedRefreshMs <= 10000) {
        state.refreshMs = storedRefreshMs;
      }

      const storedEmbedHeight = Number(localStorage.getItem('mentorEmbedHeight'));
      if (storedEmbedHeight >= 240 && storedEmbedHeight <= 1200) {
        state.embedHeight = storedEmbedHeight;
      }

      const storedLogHeight = Number(localStorage.getItem('mentorLogHeight'));
      if (storedLogHeight >= 100 && storedLogHeight <= 400) {
        state.logHeight = storedLogHeight;
      }

      const el = {
        apiInput: document.getElementById('api-base'),
        healthDot: document.getElementById('health-dot'),
        healthLabel: document.getElementById('health-label'),
        refreshLabel: document.getElementById('refresh-label'),
        updatedLabel: document.getElementById('updated-label'),
        refreshSlider: document.getElementById('refresh-slider'),
        refreshSeconds: document.getElementById('refresh-seconds'),
        embedHeightSlider: document.getElementById('embed-height-slider'),
        embedHeightValue: document.getElementById('embed-height-value'),
        logHeightSlider: document.getElementById('log-height-slider'),
        logHeightValue: document.getElementById('log-height-value'),
        tbSection: document.getElementById('tensorboard-embed'),
        tbFrame: document.getElementById('tensorboard-frame'),
        tbNote: document.getElementById('tensorboard-note'),
        tbToggle: document.getElementById('toggle-tensorboard'),
        tbStart: document.getElementById('start-tensorboard'),
        runGrid: document.getElementById('run-grid'),
        runsNote: document.getElementById('runs-note'),
        selectionChip: document.getElementById('selection-chip'),
        clearSelection: document.getElementById('clear-selection'),
        runningCount: document.getElementById('running-count'),
        completedCount: document.getElementById('completed-count'),
        failedCount: document.getElementById('failed-count'),
        processNote: document.getElementById('process-note'),
        mlagentsCount: document.getElementById('mlagents-count'),
        mlagentsNote: document.getElementById('mlagents-note'),
        envRunning: document.getElementById('env-running'),
        envNote: document.getElementById('env-note'),
        killSelect: document.getElementById('kill-select'),
        killBtn: document.getElementById('kill-btn'),
        killNote: document.getElementById('kill-note'),
        refreshBtn: document.getElementById('refresh'),
      };

      const pick = (obj, key) => obj?.[key] ?? obj?.[key.charAt(0).toUpperCase() + key.slice(1)];

      el.apiInput.value = state.apiBase;
      const initialSeconds = state.refreshMs / 1000;
      el.refreshLabel.textContent = `Every ${initialSeconds}s`;
      el.refreshSlider.value = initialSeconds;
      el.refreshSeconds.textContent = initialSeconds;
      el.embedHeightSlider.value = state.embedHeight;
      el.embedHeightValue.textContent = state.embedHeight;
      el.logHeightSlider.value = state.logHeight;
      el.logHeightValue.textContent = state.logHeight;
      document.documentElement.style.setProperty('--embed-height', `${state.embedHeight}px`);
      document.documentElement.style.setProperty('--log-height', `${state.logHeight}px`);

      function setApiBase(value) {
        if (!value) return;
        state.apiBase = value.trim().replace(/\/$/, '');
        localStorage.setItem('mentorApiBase', state.apiBase);
      }

      function setRefreshMs(seconds) {
        const fallback = state.refreshMs / 1000;
        const secs = Math.min(10, Math.max(1, Number(seconds) || fallback));
        state.refreshMs = secs * 1000;
        localStorage.setItem('mentorRefreshMs', state.refreshMs);
        el.refreshSeconds.textContent = secs;
        el.refreshSlider.value = secs;
        scheduleNextRefresh();
      }

      function setEmbedHeight(px) {
        const fallback = state.embedHeight;
        const value = Math.min(1200, Math.max(240, Number(px) || fallback));
        state.embedHeight = value;
        localStorage.setItem('mentorEmbedHeight', value);
        el.embedHeightSlider.value = value;
        el.embedHeightValue.textContent = value;
        document.documentElement.style.setProperty('--embed-height', `${value}px`);
        state.forceTensorboardReload = true;
      }

      function setLogHeight(px) {
        const fallback = state.logHeight;
        const value = Math.min(400, Math.max(100, Number(px) || fallback));
        state.logHeight = value;
        localStorage.setItem('mentorLogHeight', value);
        el.logHeightSlider.value = value;
        el.logHeightValue.textContent = value;
        document.documentElement.style.setProperty('--log-height', `${value}px`);
      }

      function deriveLogPath(run) {
        const direct = pick(run, 'logPath');
        if (direct) return direct;

        const statusPath = pick(run, 'trainingStatusPath');
        if (statusPath) {
          const base = statusPath.replace(/training_status\.json$/i, '').replace(/[\\/]+$/, '');
          if (base) {
            return `${base}/mentor-api.log`;
          }
        }

        const resultsDir = pick(run, 'resultsDirectory');
        const runId = pick(run, 'runId');
        if (resultsDir && runId) {
          return [resultsDir, runId, 'run_logs', 'mentor-api.log'].join('/');
        }

        return null;
      }

      function toFileUrl(path) {
        if (!path) return null;
        const normalized = path.replace(/\\/g, '/');
        if (/^[a-zA-Z]:\//.test(normalized)) {
          return `file:///${encodeURI(normalized)}`;
        }
        if (normalized.startsWith('/')) {
          return `file://${encodeURI(normalized)}`;
        }
        return null;
      }

      async function fetchJson(url) {
        const response = await fetch(url, { headers: { Accept: 'application/json' } });
        if (!response.ok) {
          const text = await response.text();
          throw new Error(text || `Request failed (${response.status})`);
        }
        return response.json();
      }

      async function postJson(url, body) {
        const response = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', Accept: 'application/json' },
          body: JSON.stringify(body || {}),
        });
        const text = await response.text();
        if (!response.ok) {
          let message = text || `Request failed (${response.status})`;
          try {
            const parsed = JSON.parse(text);
            message = parsed?.error || parsed?.message || message;
          } catch { /* ignore parse errors */ }
          throw new Error(message);
        }
        if (!text) return {};
        try {
          return JSON.parse(text);
        } catch {
          return {};
        }
      }

      async function updateHealth() {
        try {
          const data = await fetchJson(`${state.apiBase}/health`);
          const healthy = data && data.status === 'ok';
          renderHealth(healthy, healthy ? 'Operational' : 'Degraded');
        } catch (err) {
          renderHealth(false, 'Offline');
          el.runsNote.textContent = 'API unreachable. Check the base URL or start mentor-api.';
          console.error(err);
        }
      }

      function renderHealth(isUp, label) {
        el.healthLabel.textContent = label;
        el.healthDot.classList.remove('off', 'degraded');
        if (!isUp) {
          el.healthDot.classList.add('off');
        }
      }

      function updateRefreshLabel() {
        if (!state.nextRefreshAt) {
          el.refreshLabel.textContent = `Every ${state.refreshMs / 1000}s`;
          return;
        }
        const remainingMs = Math.max(0, state.nextRefreshAt - Date.now());
        const seconds = Math.ceil(remainingMs / 1000);
        el.refreshLabel.textContent = `Next refresh in ${seconds}s`;
      }

      function startTicker() {
        if (state.tickerHandle) {
          clearInterval(state.tickerHandle);
        }
        updateRefreshLabel();
        state.tickerHandle = setInterval(updateRefreshLabel, 500);
      }

      function statusClass(status) {
        const normalized = (status || '').toLowerCase();
        if (normalized === 'running') return 'status-running';
        if (normalized === 'succeeded' || normalized === 'success' || normalized === 'completed') return 'status-succeeded';
        if (normalized === 'failed' || normalized === 'failure') return 'status-failed';
        if (normalized === 'canceled' || normalized === 'cancelled') return 'status-canceled';
        if (normalized === 'unknown') return 'status-unknown';
        return 'status-not-found';
      }

      function renderRuns(runs, errorMessage) {
        el.runGrid.innerHTML = '';
        if (errorMessage) {
          const div = document.createElement('div');
          div.className = 'empty';
          div.textContent = errorMessage;
          el.runGrid.appendChild(div);
          setCounts([]);
          renderTensorboard([], state.forceTensorboardReload);
          state.hiddenRuns.clear();
          state.lastRuns = [];
          updateSelectionChip();
          return;
        }
        const list = Array.isArray(runs) ? runs.slice() : [];
        state.lastRuns = list;
        if (!list.length) {
          const div = document.createElement('div');
          div.className = 'empty';
          div.textContent = 'No runs yet. Kick off training to see status here.';
          el.runGrid.appendChild(div);
          setCounts([]);
          renderTensorboard([], state.forceTensorboardReload);
          state.hiddenRuns.clear();
          updateSelectionChip();
          return;
        }
        list.sort((a, b) => Number(pick(a, 'completed')) - Number(pick(b, 'completed')));
        pruneSelection(list.map(r => pick(r, 'runId')).filter(Boolean));
        list.forEach(run => el.runGrid.appendChild(buildCard(run)));

        setCounts(list);
        el.runsNote.textContent = `${list.length} run${list.length === 1 ? '' : 's'} tracked`;
        renderTensorboard(list, state.forceTensorboardReload);
        updateSelectionChip();
      }

      function buildCard(run) {
        const card = document.createElement('div');
        card.className = 'card';
        const header = document.createElement('div');
        header.className = 'card-header';
        const runId = pick(run, 'runId') || 'Unknown run';
        const runParams = pick(run, 'parameters') || {};
        const resumeFlag = pick(run, 'resumeOnStart') ?? pick(runParams, 'resumeOnStart');
        const isCompleted = !!pick(run, 'completed');
        const logPath = deriveLogPath(run);
        const logUrl = toFileUrl(logPath) ?? logPath;
        const selection = document.createElement('input');
        selection.type = 'checkbox';
        selection.ariaLabel = `Show details for ${runId}`;
        const detailsVisible = !state.hiddenRuns.has(runId);
        selection.checked = detailsVisible;
        selection.addEventListener('click', (event) => {
          event.stopPropagation();
          toggleRunSelection(runId, selection.checked);
        });
        const id = document.createElement('div');
        id.className = 'run-id';
        id.textContent = runId;
        const toggleLabel = document.createElement('div');
        toggleLabel.className = 'pill-label';
        toggleLabel.textContent = 'Details';
        const chip = document.createElement('div');
        const statusText = pick(run, 'status');
        const sClass = statusClass(statusText);
        chip.className = `status-chip ${sClass}`;
        const dot = document.createElement('span');
        dot.className = 'status-dot';
        const label = document.createElement('span');
        label.textContent = statusText || 'unknown';
        chip.append(dot, label);
        const selectionWrap = document.createElement('div');
        selectionWrap.style.display = 'flex';
        selectionWrap.style.alignItems = 'center';
        selectionWrap.style.gap = '6px';
        selectionWrap.append(selection, toggleLabel);
        const archiveBtn = createArchiveButton(runId);
        const resumeControl = document.createElement('div');
        resumeControl.className = 'resume-inline';
        const resumeToggle = document.createElement('input');
        resumeToggle.type = 'checkbox';
        resumeToggle.checked = isCompleted ? false : !!resumeFlag;
        resumeToggle.disabled = isCompleted;
        resumeToggle.addEventListener('click', (event) => event.stopPropagation());
        const resumeLabel = document.createElement('div');
        resumeLabel.className = 'pill-label';
        resumeLabel.textContent = 'Resume';
        const resumeNote = document.createElement('div');
        resumeNote.className = 'resume-note';
        const setResumeNote = (value) => {
          if (isCompleted) {
            resumeNote.textContent = 'Completed';
          } else {
            resumeNote.textContent = value ? 'On' : 'Off';
          }
        };
        setResumeNote(resumeToggle.checked);
        resumeToggle.addEventListener('change', async (event) => {
          if (isCompleted) return;
          const desired = event.target.checked;
          resumeToggle.disabled = true;
          resumeNote.textContent = 'Saving...';
          try {
            await postJson(`${state.apiBase}/train/resume-flag`, { runId, resumeOnStart: desired, resultsDir: pick(run, 'resultsDirectory') });
            setResumeNote(desired);
            await refreshAll();
          } catch (err) {
            console.error(err);
            resumeToggle.checked = !desired;
            resumeNote.textContent = err?.message || 'Failed to update';
          } finally {
            resumeToggle.disabled = isCompleted ? true : false;
          }
        });
        resumeControl.append(resumeToggle, resumeLabel, resumeNote);
        const actions = document.createElement('div');
        actions.className = 'card-actions';
        actions.append(archiveBtn, resumeControl, chip);
        header.append(selectionWrap, id, actions);

        const detailLines = [
          { key: 'Run', value: runId },
          { key: 'Status', value: statusText || 'unknown' },
          { key: 'Completed', value: isCompleted ? 'Yes' : 'No' },
          { key: 'Results', value: pick(run, 'resultsDirectory') || '-' },
          { key: 'Training status', value: pick(run, 'trainingStatusPath') || '-' },
          { key: 'TensorBoard', value: pick(run, 'tensorboardUrl') || '-' },
          { key: 'Log path', value: logPath || '-' },
          { key: 'Exit code', value: pick(run, 'exitCode') ?? '-' },
          { key: 'Env path', value: pick(runParams, 'envPath') || '-' },
          { key: 'Config', value: pick(runParams, 'configPath') || '-' },
          { key: 'Conda env', value: pick(runParams, 'condaEnv') || '-' },
          { key: 'Base port', value: pick(runParams, 'basePort') ?? '-' },
          { key: 'Graphics', value: formatFlag(pick(runParams, 'noGraphics'), 'No graphics', 'Graphics enabled') },
          { key: 'Env executable', value: formatFlag(pick(runParams, 'hasEnvExecutable'), 'Yes', 'No') },
          { key: 'Skip conda', value: formatFlag(pick(runParams, 'skipConda'), 'Skip', 'Use conda') },
          { key: 'Launch TensorBoard', value: formatFlag(pick(runParams, 'tensorboard'), 'Yes', 'No') },
          { key: 'Resume on start', value: formatFlag(resumeFlag, 'Yes', 'No') },
        ];
        const detailArea = document.createElement('div');
        detailArea.className = 'detail-text detail-list';
        detailArea.setAttribute('role', 'textbox');
        detailArea.setAttribute('aria-readonly', 'true');
        detailArea.setAttribute('aria-label', `Details for ${runId}`);
        detailLines.forEach(line => {
          const row = document.createElement('div');
          row.className = 'detail-line';
          const keySpan = document.createElement('span');
          keySpan.className = 'detail-key';
          keySpan.textContent = `${line.key}:`;
          const valueSpan = document.createElement('span');
          valueSpan.className = 'detail-value';
          valueSpan.textContent = line.value ?? '-';
          const lower = String(line.value ?? '').toLowerCase();
          if (['running', 'yes', 'true'].includes(lower) || lower === 'graphics enabled') {
            valueSpan.classList.add('positive');
          } else if (['failed', 'failure', 'not-found', 'unknown'].includes(lower) || lower.startsWith('no ')) {
            valueSpan.classList.add('negative');
          } else if (lower === '-' || lower === 'skip') {
            valueSpan.classList.add('warning');
          }
          row.append(keySpan, valueSpan);
          detailArea.append(row);
        });

        const log = document.createElement('div');
        log.className = 'log';
        const logTail = pick(run, 'logTail');
        const logs = Array.isArray(logTail) ? logTail.filter(Boolean) : [];
        log.textContent = logs.length ? logs.join('\n') : 'Waiting for log output...';
        const logActions = document.createElement('div');
        logActions.className = 'log-actions';
        const openLogBtn = document.createElement('button');
        openLogBtn.type = 'button';
        openLogBtn.className = 'secondary';
        openLogBtn.textContent = 'Open full log';
        openLogBtn.title = logPath || 'Log path unavailable';
        openLogBtn.disabled = !logUrl;
        openLogBtn.addEventListener('click', (event) => {
          event.stopPropagation();
          if (logUrl) {
            window.open(logUrl, '_blank', 'noopener,noreferrer');
          } else {
            alert('Log path unavailable for this run.');
          }
        });
        logActions.append(openLogBtn);

        const detailsWrap = document.createElement('div');
        detailsWrap.className = 'card-details';
        const message = pick(run, 'message');
        if (message) {
          const msg = document.createElement('div');
          msg.className = 'meta';
          const labelEl = document.createElement('div');
          labelEl.className = 'label';
          labelEl.textContent = 'Message';
          const text = document.createElement('div');
          text.textContent = message;
          msg.append(labelEl, text);
          detailsWrap.append(detailArea, msg, log, logActions);
        } else {
          detailsWrap.append(detailArea, log, logActions);
        }

        detailsWrap.hidden = !detailsVisible;
        card.append(header, detailsWrap);
        if (!detailsVisible) {
          card.classList.add('collapsed');
        } else {
          card.classList.add('selected');
        }

        card.addEventListener('click', () => {
          const next = state.hiddenRuns.has(runId);
          selection.checked = next;
          toggleRunSelection(runId, next);
        });
        return card;
      }

      function createArchiveButton(runId) {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'icon-btn';
        btn.title = `Archive ${runId}`;
        btn.innerHTML = `<svg viewBox="0 0 20 20" fill="none" aria-hidden="true"><path fill="currentColor" d="M4.25 6.5c-.966 0-1.75.784-1.75 1.75v7a1.75 1.75 0 0 0 1.75 1.75h11.5A1.75 1.75 0 0 0 17.5 15.25v-7c0-.966-.784-1.75-1.75-1.75H4.25Zm-.25 1.75c0-.138.112-.25.25-.25h11.5c.138 0 .25.112.25.25v7c0 .138-.112.25-.25.25H4.25a.25.25 0 0 1-.25-.25v-7Zm9.86-3.5-1.04-2.306A.75.75 0 0 0 12.109 2H7.891a.75.75 0 0 0-.671.394L6.18 4.75H4.75a.75.75 0 0 0 0 1.5h10.5a.75.75 0 0 0 0-1.5h-1.39ZM8.55 3.5h2.9l.45 1H8.1l.45-1Zm2.81 4.29a.75.75 0 0 0-1.06 0l-.8.8-.8-.8a.75.75 0 1 0-1.06 1.06l.8.8-.8.8a.75.75 0 1 0 1.06 1.06l.8-.8.8.8a.75.75 0 0 0 1.06-1.06l-.8-.8.8-.8a.75.75 0 0 0 0-1.06Z"/></svg>`;
        btn.addEventListener('click', async (event) => {
          event.stopPropagation();
          await archiveRun(runId, btn);
        });
        return btn;
      }

      function formatFlag(value, truthyLabel = 'Yes', falsyLabel = 'No') {
        if (value === true) return truthyLabel;
        if (value === false) return falsyLabel;
        return '-';
      }

      function toggleRunSelection(runId, selected) {
        if (!runId) return;
        if (selected) {
          state.hiddenRuns.delete(runId);
        } else {
          state.hiddenRuns.add(runId);
        }
        updateSelectionChip();
        document.querySelectorAll('.card').forEach(card => {
          const title = card.querySelector('.run-id')?.textContent;
          if (title === runId) {
            const details = card.querySelector('.card-details');
            if (details) {
              details.hidden = !selected;
            }
            card.classList.toggle('selected', selected);
            card.classList.toggle('collapsed', !selected);
          }
        });
      }

      async function archiveRun(runId, button) {
        if (!runId) return;
        if (button) {
          button.disabled = true;
          button.classList.add('spinning');
        }
        try {
          await postJson(`${state.apiBase}/train/archive`, { runId });
          state.lastRuns = state.lastRuns.filter(r => pick(r, 'runId') !== runId);
          renderRuns(state.lastRuns);
        } catch (err) {
          console.error(err);
          const message = (err?.message || 'Failed to archive run.').trim();
          el.runsNote.textContent = message;
          if (button) {
            button.classList.add('error');
            setTimeout(() => button.classList.remove('error'), 1400);
          }
        } finally {
          if (button) {
            button.disabled = false;
            button.classList.remove('spinning');
          }
        }
      }

      function renderTensorboard(runs, forceReload = false) {
        const list = Array.isArray(runs) ? runs : [];
        const withTb = list.find(r => pick(r, 'tensorboardUrl'));
        const url = withTb ? pick(withTb, 'tensorboardUrl') : defaultTensorboardUrl;
        const note = withTb ? `From run ${pick(withTb, 'runId') || 'unknown'}` : 'Default (localhost:6006)';
        if (!url) {
          el.tbSection.hidden = true;
          el.tbFrame.removeAttribute('src');
          state.tensorboardUrl = null;
          return;
        }
        const current = el.tbFrame.getAttribute('src');
        const shouldReload = forceReload || current !== url;
        if (shouldReload) {
          const resetUrl = 'about:blank';
          el.tbFrame.setAttribute('src', resetUrl);
          setTimeout(() => {
            el.tbFrame.setAttribute('src', url);
          }, 0);
        }
        state.tensorboardUrl = url;
        el.tbNote.textContent = note;
        el.tbSection.hidden = false;
        el.tbToggle.textContent = state.tensorboardCollapsed ? 'Expand' : 'Collapse';
        el.tbFrame.closest('.embed-frame').style.display = state.tensorboardCollapsed ? 'none' : 'block';
        document.querySelector('.tb-controls')?.classList.toggle('collapsed', state.tensorboardCollapsed);
      }

      async function startTensorboard() {
        if (!el.tbStart) return;
        const originalText = el.tbStart.textContent;
        el.tbStart.disabled = true;
        el.tbStart.textContent = 'Starting...';
        el.tbNote.textContent = 'Starting TensorBoard...';
        try {
          const data = await fetchJson(`${state.apiBase}/tensorboard/start`);
          const message = pick(data, 'message') || (pick(data, 'alreadyRunning') ? 'TensorBoard already running.' : 'TensorBoard started.');
          const url = pick(data, 'url') || defaultTensorboardUrl;
          if (url) {
            const current = el.tbFrame.getAttribute('src');
            if (current !== url) {
              el.tbFrame.setAttribute('src', url);
            }
            el.tbSection.hidden = false;
          }
          el.tbNote.textContent = message;
          await refreshAll();
        } catch (err) {
          console.error(err);
          el.tbNote.textContent = err?.message || 'Failed to start TensorBoard.';
        } finally {
          el.tbStart.disabled = false;
          el.tbStart.textContent = originalText;
        }
      }

      function setCounts(runs) {
        const summary = runs.reduce((acc, run) => {
          const status = (pick(run, 'status') || '').toLowerCase();
          if (status === 'running') acc.running += 1;
          if (status === 'failed' || status === 'failure') acc.failed += 1;
          if (pick(run, 'completed')) acc.completed += 1;
          return acc;
        }, { running: 0, completed: 0, failed: 0 });
        el.runningCount.textContent = summary.running;
        el.completedCount.textContent = summary.completed;
        el.failedCount.textContent = summary.failed;
      }

      function pruneSelection(validRunIds) {
        const valid = new Set(validRunIds);
        state.hiddenRuns = new Set([...state.hiddenRuns].filter(id => valid.has(id)));
      }

      function updateSelectionChip() {
        const total = state.lastRuns.length;
        const hidden = state.hiddenRuns.size;
        const visible = Math.max(0, total - hidden);
        el.selectionChip.textContent = `${visible} of ${total} showing details`;
      }

      function updateKillOptions(knownList) {
        const select = el.killSelect;
        const previous = select.value;
        const options = ['mlagents-learn.exe', 'tensorboard', ...new Set(Array.isArray(knownList) ? knownList : [])];
        select.innerHTML = '<option value="">Select executable</option>';
        options.forEach(name => {
          const opt = document.createElement('option');
          opt.value = name;
          opt.textContent = name;
          select.append(opt);
        });
        if (previous && options.includes(previous)) {
          select.value = previous;
        }
      }

      function renderProcessStatus(status, errorMessage) {
        const data = status || {};
        const resultsDir = pick(data, 'resultsDirectory') || 'Unknown results dir';
        const processError = errorMessage || null;
        el.processNote.textContent = processError ?? `Results dir: ${resultsDir}`;

        const count = Number(pick(data, 'mlagentsLearnProcesses') ?? 0);
        const safeCount = Number.isFinite(count) ? count : 0;
        el.mlagentsCount.textContent = safeCount;
        el.mlagentsNote.textContent = `${safeCount === 1 ? 'process' : 'processes'} running`;

        el.envRunning.innerHTML = '';
        if (processError) {
          const chip = document.createElement('div');
          chip.className = 'chip alert';
          chip.textContent = 'Process info unavailable';
          el.envRunning.append(chip);
          el.envNote.textContent = 'Refresh or verify the API to restore process visibility.';
          state.knownEnvExecutables = [];
          updateKillOptions(state.knownEnvExecutables);
          return;
        }

        const running = (() => {
          const value = pick(data, 'runningEnvExecutables');
          return Array.isArray(value) ? value.filter(Boolean) : [];
        })();
        const known = (() => {
          const value = pick(data, 'knownEnvExecutables');
          return Array.isArray(value) ? value.filter(Boolean) : [];
        })();

        state.knownEnvExecutables = known;
        updateKillOptions(state.knownEnvExecutables);

        if (!running.length) {
          const chip = document.createElement('div');
          chip.className = 'chip';
          chip.textContent = 'No env executables running';
          el.envRunning.append(chip);
        } else {
          running.forEach(name => {
            const chip = document.createElement('div');
            chip.className = 'chip';
            chip.textContent = name;
            el.envRunning.append(chip);
          });
        }

        if (known.length) {
          el.envNote.textContent = `Tracking ${known.length} env exe${known.length === 1 ? '' : 's'} from results folders.`;
        } else {
          el.envNote.textContent = 'No env executables discovered in results folders yet.';
        }
      }

      async function updateProcessStatus() {
        try {
          const data = await fetchJson(`${state.apiBase}/process-status`);
          renderProcessStatus(data);
        } catch (err) {
          console.error(err);
          renderProcessStatus(null, 'Unable to load process info.');
          throw err;
        }
      }

      async function killSelectedExecutable() {
        const executable = el.killSelect.value;
        if (!executable) {
          el.killNote.textContent = 'Pick an executable to kill.';
          return;
        }
        el.killBtn.disabled = true;
        el.killBtn.textContent = 'Killing...';
        try {
          const result = await postJson(`${state.apiBase}/process-kill`, { executable });
          const matched = Number(pick(result, 'matchedProcesses') ?? 0);
          const killed = Number(pick(result, 'killedProcesses') ?? 0);
          const errors = Array.isArray(result?.errors) ? result.errors.filter(Boolean) : [];
          if (errors.length) {
            el.killNote.textContent = `${executable}: matched ${matched}, killed ${killed}. Errors: ${errors.join(' | ')}`;
          } else {
            el.killNote.textContent = `${executable}: matched ${matched}, killed ${killed}.`;
          }
          await updateProcessStatus();
        } catch (err) {
          console.error(err);
          el.killNote.textContent = err?.message || 'Failed to kill processes.';
        } finally {
          el.killBtn.disabled = false;
          el.killBtn.textContent = 'Kill all';
        }
      }

      async function refreshAll() {
        await Promise.all([
          updateHealth(),
          fetchJson(`${state.apiBase}/train-status`).then(data => renderRuns(data)).catch(err => {
            console.error(err);
            renderRuns([], 'Unable to load runs.');
          }),
          updateProcessStatus().catch(() => {})
        ]);
        const now = new Date();
        el.updatedLabel.textContent = now.toLocaleTimeString();
        state.forceTensorboardReload = false;
      }

      function scheduleNextRefresh() {
        if (state.refreshHandle) {
          clearTimeout(state.refreshHandle);
        }
        state.nextRefreshAt = Date.now() + state.refreshMs;
        updateRefreshLabel();
        state.refreshHandle = setTimeout(async () => {
          await refreshAll();
          scheduleNextRefresh();
        }, state.refreshMs);
      }

      function startLoop() {
        if (state.refreshHandle) {
          clearTimeout(state.refreshHandle);
        }
        if (state.tickerHandle) {
          clearInterval(state.tickerHandle);
        }
        state.nextRefreshAt = Date.now() + state.refreshMs;
        startTicker();
        refreshAll();
        state.refreshHandle = setTimeout(async () => {
          await refreshAll();
          scheduleNextRefresh();
        }, state.refreshMs);
      }

      el.refreshBtn.addEventListener('click', async () => {
        state.forceTensorboardReload = true;
        await refreshAll();
        scheduleNextRefresh();
        state.forceTensorboardReload = false;
      });
      el.refreshSlider.addEventListener('input', (event) => {
        setRefreshMs(event.target.value);
      });
      el.embedHeightSlider.addEventListener('input', (event) => {
        setEmbedHeight(event.target.value);
      });
      el.logHeightSlider.addEventListener('input', (event) => {
        setLogHeight(event.target.value);
      });
      const applyApiBase = () => {
        state.forceTensorboardReload = true;
        setApiBase(el.apiInput.value);
        refreshAll();
        scheduleNextRefresh();
      };
      el.apiInput.addEventListener('change', applyApiBase);
      el.apiInput.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
          applyApiBase();
        }
      });
      el.tbStart?.addEventListener('click', startTensorboard);
      el.tbToggle?.addEventListener('click', () => {
        state.tensorboardCollapsed = !state.tensorboardCollapsed;
        renderTensorboard(state.lastRuns, true);
      });
      el.killBtn.addEventListener('click', killSelectedExecutable);
      el.clearSelection.addEventListener('click', () => {
        state.hiddenRuns.clear();
        updateSelectionChip();
        document.querySelectorAll('.card').forEach(card => {
          card.classList.remove('collapsed');
          card.classList.add('selected');
          const details = card.querySelector('.card-details');
          if (details) details.hidden = false;
        });
        document.querySelectorAll('.card input[type="checkbox"]').forEach(cb => { cb.checked = true; });
      });
      startLoop();
    })();
  </script>
</body>
</html>


